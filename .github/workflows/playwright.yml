name: Full QA Pipeline (Playwright + Accessibility + Lint + Cross-Browser)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  qa-checks:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      # -------------------------------
      # STEP 1 â€” ESLint + Tailwind Rules
      # -------------------------------
      - name: ğŸ§¹ Lint JavaScript, TailwindCSS, and responsive utilities
        run: |
          echo "ğŸ” Running ESLintâ€¦"
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings=0
        continue-on-error: false

      # -------------------------------
      # STEP 2 â€” Stylelint (CSS rules)
      # -------------------------------
      - name: ğŸ¨ Check CSS consistency
        run: |
          echo "ğŸ¨ Running Stylelintâ€¦"
          npx stylelint "**/*.css" || echo "No CSS files found"
        continue-on-error: false

      # -------------------------------
      # STEP 3 â€” Accessibility (axe-core)
      # -------------------------------
      - name: â™¿ Accessibility Audits (WCAG + Contrast)
        run: |
          echo "â™¿ Running accessibility testsâ€¦"
          npx playwright test tests/accessibility/axe.spec.js --reporter=dot
        continue-on-error: false

      # ------------------------------------------
      # STEP 4 â€” Cross-Browser + Responsive Testing
      # ------------------------------------------
      - name: ğŸŒ Cross-Browser Visual Regression
        run: |
          echo "ğŸŒ Running visual regression on Chromium, Firefox, WebKitâ€¦"
          npx playwright test --project=Chromium --project=Firefox --project=WebKit --reporter=html
        env:
          CI: true
        continue-on-error: false

      # -------------------------------
      # STEP 5 â€” Upload Playwright Report
      # -------------------------------
      - name: ğŸ“Š Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      # ----------------------------------------------------
      # STEP 6 â€” Tailwind Enforcement (No Arbitrary Values)
      # ----------------------------------------------------
      - name: ğŸ¨ Validate Tailwind Design System Enforcement
        run: |
          echo "ğŸ§± Validating Tailwind usageâ€¦"

          # âŒ Fail if arbitrary values like bg-[#123456] exist
          if grep -R "class=.*\[.*\]" src/ tests/ 2>/dev/null; then
            echo "âŒ Arbitrary Tailwind values detected! Use semantic theme colors."
            exit 1
          fi

          # âŒ Fail if max-w-* fixed widths are used
          if grep -R "max-w-[0-9]" src/ tests/ 2>/dev/null; then
            echo "âŒ Fixed-width container detected! Layout must be fluid."
            exit 1
          fi
        continue-on-error: false
        shell: bash

      # ----------------------------------------------------
      # STEP 7 â€” Check Design System Documentation
      # ----------------------------------------------------
      - name: ğŸ“˜ Validate Design System Documentation
        run: |
          echo "ğŸ“˜ Checking design-system.mdâ€¦"
          if [ ! -f docs/design-system.md ]; then
            echo "âŒ Missing docs/design-system.md (Design System Documentation Required)"
            exit 1
          fi
          echo "âœ… Design System Documentation exists."
        continue-on-error: false
